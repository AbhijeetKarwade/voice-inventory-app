<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Inventory Manager</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .tab { display: none; }
        .tab.active { display: block; }
        .notification { display: none; color: green; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        button { margin: 5px; padding: 8px 16px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Voice Inventory Manager</h1>
        <div class="tabs">
            <button onclick="openTab('voice-tab')">Voice Input</button>
            <button onclick="openTab('manual-tab')">Manual Input</button>
            <button onclick="openTab('inventory-tab')">Inventory</button>
            <button onclick="openTab('settings-tab')">Settings</button>
        </div>

        <!-- Voice Input Tab -->
        <div id="voice-tab" class="tab">
            <h3>Add Inward/Outward Inventories</h3>
            <button onclick="startListening('inward')">Inward</button>
            <button onclick="startListening('outward')">Outward</button>
        </div>

        <!-- Manual Input Tab -->
        <div id="manual-tab" class="tab">
            <h3>Manual Inventory Entry</h3>
            <form id="manual-inventory-form">
                <label>Date: <input type="datetime-local" id="date" required></label><br>
                <label>Vendor: <input type="text" id="vendor" required></label><br>
                <label>Item: <input type="text" id="item" required></label><br>
                <label>Quantity: <input type="number" id="quantity" required></label><br>
                <label>Unit: <input type="text" id="unit" required></label><br>
                <label>Session: 
                    <select id="session" required>
                        <option value="inward">Inward</option>
                        <option value="outward">Outward</option>
                    </select>
                </label><br>
                <button type="submit">Add Entry</button>
            </form>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory-tab" class="tab active">
            <h3>Inventory Items</h3>
            <button onclick="saveInventory()">Save</button>
            <div class="dropdown">
                <button>Export</button>
                <div class="dropdown-content">
                    <a href="#" onclick="exportInventory('csv')">CSV</a>
                    <a href="#" onclick="exportInventory('excel')">Excel</a>
                    <a href="#" onclick="exportInventory('pdf')">PDF</a>
                </div>
            </div>
            <table id="inventory-table">
                <tr>
                    <th>#</th>
                    <th>Time</th>
                    <th>Vendor</th>
                    <th>Item</th>
                    <th>Quantity</th>
                    <th>Session</th>
                    <th>Actions</th>
                </tr>
                <tr><td colspan="7">No inventory items yet. Use manual or voice commands to add items.</td></tr>
            </table>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab">
            <h3>Settings</h3>
            <div>
                <h4>Vendors</h4>
                <input type="text" id="vendor-input" placeholder="Enter vendor name">
                <button onclick="addVendor()">Add</button>
                <ul id="vendor-list"></ul>
            </div>
            <div>
                <h4>Materials</h4>
                <input type="text" id="material-input" placeholder="Enter material name">
                <input type="text" id="unit-input" placeholder="Enter unit">
                <button onclick="addMaterial()">Add</button>
                <ul id="material-list"></ul>
            </div>
            <div>
                <h4>Import Vendor List (Excel)</h4>
                <input type="file" id="vendor-excel" accept=".xlsx">
                <button onclick="importExcel('vendors.json')">Import</button>
            </div>
            <div>
                <h4>Import Material List (Excel)</h4>
                <input type="file" id="material-excel" accept=".xlsx">
                <button onclick="importExcel('materials.json')">Import</button>
            </div>
            <div>
                <h4>Import Unit List (Excel)</h4>
                <input type="file" id="unit-excel" accept=".xlsx">
                <button onclick="importExcel('units.json')">Import</button>
            </div>
            <div>
                <button onclick="clearJson('inventory.json')">Clear Inventory</button>
                <button onclick="clearJson('vendors.json')">Clear Vendors</button>
                <button onclick="clearJson('materials.json')">Clear Materials</button>
                <button onclick="clearJson('units.json')">Clear Units</button>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification">Item added successfully.</div>
    </div>

    <script>
        let inventoryItems = [];

        function openTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        function startListening(session) {
            fetch('/start_listening', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message);
                checkSessionStatus();
            });
        }

        function checkSessionStatus() {
            fetch('/session_status')
            .then(response => response.json())
            .then(data => {
                if (data.active && data.entry.length > 0) {
                    inventoryItems = data.entry.map((item, index) => ({
                        id: index + 1,
                        date: item[0],
                        vendor: item[1],
                        item: item[2],
                        quantity: item[3],
                        unit: item[4],
                        session: item[5]
                    }));
                    updateInventoryTable();
                }
            });
        }

        function saveInventory() {
            fetch('/save_inventory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: inventoryItems })
            })
            .then(response => response.json())
            .then(data => showNotification(data.message));
        }

       function exportInventory(format) {
            fetch('/export_entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: 'inventory', format })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message);
                window.location.href = `/download/inventory.${format}`;
            });
        }

        function addVendor() {
            const vendor = document.getElementById('vendor-input').value;
            if (vendor) {
                fetch('/add_vendor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendor })
                })
                .then(response => response.json())
                .then(data => showNotification(data.message));
            }
        }

        function addMaterial() {
            const material = document.getElementById('material-input').value;
            const unit = document.getElementById('unit-input').value;
            if (material) {
                fetch('/add_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ material, unit })
                })
                .then(response => response.json())
                .then(data => showNotification(data.message));
            }
        }

        function importExcel(outputFile) {
            const input = outputFile.includes('vendors') ? document.getElementById('vendor-excel') :
                          outputFile.includes('materials') ? document.getElementById('material-excel') :
                          document.getElementById('unit-excel');
            const file = input.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('output_file', outputFile);
                formData.append('columns', outputFile.includes('vendors') ? 'vendor' : outputFile.includes('materials') ? 'material' : 'unit');
                fetch('/import_excel', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => showNotification(data.message));
            }
        }

        function clearJson(filename) {
            fetch('/clear_entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            })
            .then(response => response.json())
            .then(data => showNotification(data.message));
        }

        function updateInventoryTable() {
            const table = document.getElementById('inventory-table');
            table.innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Time</th>
                    <th>Vendor</th>
                    <th>Item</th>
                    <th>Quantity</th>
                    <th>Session</th>
                    <th>Actions</th>
                </tr>
            `;
            if (inventoryItems.length === 0) {
                table.innerHTML += '<tr><td colspan="7">No inventory items yet. Use manual or voice commands to add items.</td></tr>';
            } else {
                inventoryItems.forEach(item => {
                    table.innerHTML += `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.date}</td>
                            <td>${item.vendor}</td>
                            <td>${item.item}</td>
                            <td>${item.quantity}</td>
                            <td>${item.session}</td>
                            <td><button onclick="removeEntry(${item.id})">Delete</button></td>
                        </tr>
                    `;
                });
            }
        }

        function removeEntry(id) {
            const item = inventoryItems.find(item => item.id === id);
            fetch('/remove_entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ entry: [item.date, item.vendor, item.item, item.quantity, item.unit, item.session] })
            })
            .then(response => response.json())
            .then(data => {
                inventoryItems = inventoryItems.filter(item => item.id !== id);
                updateInventoryTable();
                showNotification(data.message);
            });
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        document.getElementById('manual-inventory-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const date = document.getElementById('date').value.replace('T', ' ');
            const vendor = document.getElementById('vendor').value;
            const item = document.getElementById('item').value;
            const quantity = document.getElementById('quantity').value;
            const unit = document.getElementById('unit').value;
            const session = document.getElementById('session').value;
            const newItem = {
                id: inventoryItems.length + 1,
                date,
                vendor,
                item,
                quantity,
                unit,
                session
            };
            inventoryItems.push(newItem);
            updateInventoryTable();
            showNotification('Item added to table. Click Save to store.');
            this.reset();
        });

        // Initialize
        openTab('inventory-tab');
    </script>
</body>
</html>